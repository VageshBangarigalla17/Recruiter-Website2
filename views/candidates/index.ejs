<%- include('../partials/header') %>

<main class="flex-grow mx-auto p-4 sm:p-6 lg:p-8 max-w-full lg:max-w-screen-2xl">

  <style>
    @keyframes fadeUp { from {opacity:0; transform:translateY(8px)} to{opacity:1;transform:translateY(0);} }
    .fade-up { animation: fadeUp 380ms ease-out both; }
    .typing-caret { display:inline-block; width:2px; background:currentColor; margin-left:6px; animation:blink 1s step-end infinite; height:1em; vertical-align:middle;}
    @keyframes blink {50% {opacity:0}}
  </style>

  <!-- Filters + Actions row -->
  <div class="flex flex-wrap items-center justify-between mb-6 gap-4">
    <h2 class="text-3xl font-bold text-gray-800 mb-0">Candidates</h2>

    <!-- Single unified search form -->
    <form method="GET" action="/candidates" class="flex items-center gap-3 flex-1 min-w-[260px] max-w-xl">
      <div class="relative flex-1">
        <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
          <i class="fa-solid fa-magnifying-glass text-gray-400"></i>
        </span>
        <input
          type="text"
          name="q"
          placeholder="Search by ref, name, mobile, or position..."
          value="<%= filter.q || '' %>"
          class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 pl-10 w-full"
        />
      </div>

      <button type="submit" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 text-sm rounded-lg transition">
        Search
      </button>

      <a href="/candidates" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-3 py-2 text-sm rounded-lg transition">
        Refresh
      </a>
    </form>

    <!-- Action buttons -->
    <div class="flex flex-col sm:flex-row gap-2">
      <a href="/candidates/new" class="inline-flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 text-sm rounded-lg transition">
        <i class="fa-solid fa-plus"></i> Add Candidate
      </a>

      <a href="/candidates/export?<%= filter.q ? 'q='+encodeURIComponent(filter.q) : '' %>" class="inline-flex items-center gap-2 bg-blue-900 hover:bg-blue-800 text-white font-semibold rounded-lg transition px-4 py-2 text-sm shadow">
        <i class="fa-solid fa-file-excel"></i> Export to Excel
      </a>
    </div>
  </div>

  <!-- TABLE (md+) -->
  <div class="hidden md:block bg-white shadow-md rounded-lg overflow-auto fade-up">
    <table class="min-w-full text-left text-sm whitespace-nowrap">
      <thead class="bg-gray-100 sticky top-0 z-10">
        <tr>
          <th class="px-3 py-2 font-medium text-gray-700">Ref. No.</th>
          <th class="px-3 py-2 font-medium text-gray-700">Recruiter</th>
          <th class="px-3 py-2 font-medium text-gray-700">Date</th>
          <th class="px-3 py-2 font-medium text-gray-700">Source</th>
          <th class="px-3 py-2 font-medium text-gray-700">Name</th>
          <th class="px-3 py-2 font-medium text-gray-700">Mobile</th>
          <th class="px-3 py-2 font-medium text-gray-700">Position</th>
          <th class="px-3 py-2 font-medium text-gray-700">HR Status</th>
          <th class="px-3 py-2 font-medium text-gray-700">Client Status</th>
          <th class="px-3 py-2 font-medium text-gray-700">Final Status</th>
          <th class="px-3 py-2 font-medium text-gray-700">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        <% if (!candidates || candidates.length === 0) { %>
          <tr><td colspan="11" class="px-4 py-6 text-center text-gray-500">No candidates found.</td></tr>
        <% } else { %>
          <% candidates.forEach(c => { %>
            <tr class="hover:bg-gray-50">
              <td class="px-3 py-2 text-xs"><%= c.serialRefNumber || '—' %></td>
              <td class="px-3 py-2 text-xs"><%= c.createdBy?.username || '—' %></td>
              <td class="px-3 py-2 text-xs"><%= c.dateOfCall ? (new Date(c.dateOfCall)).toISOString().slice(0,10) : '—' %></td>
              <td class="px-3 py-2 text-xs"><%= c.source || '—' %></td>
              <td class="px-3 py-2 text-xs"><%= c.candidateName || '—' %></td>
              <td class="px-3 py-2 text-xs"><%= c.mobile || '—' %></td>
              <td class="px-3 py-2 text-xs"><%= c.position || '—' %></td>

              <td class="px-3 py-2 text-xs">
                <% if (c.hrStatus) { %>
                  <span class="px-2 py-0.5 rounded-full text-xs font-semibold
                    <%= c.hrStatus==='Reject' ? 'bg-red-100 text-red-800' :
                       c.hrStatus==='Hold'   ? 'bg-yellow-100 text-yellow-800' :
                       c.hrStatus==='Backup' ? 'bg-blue-100 text-blue-800' :
                       'bg-gray-100 text-gray-800' %>"><%= c.hrStatus %></span>
                <% } else { %>—<% } %>
              </td>

              <td class="px-3 py-2 text-xs">
                <% if (c.clientStatus) { %>
                  <span class="px-2 py-0.5 rounded-full text-xs font-semibold
                    <%= c.clientStatus==='Reject' ? 'bg-red-100 text-red-800' :
                       c.clientStatus==='Hold'   ? 'bg-yellow-100 text-yellow-800' :
                       'bg-gray-100 text-gray-800' %>"><%= c.clientStatus %></span>
                <% } else { %>—<% } %>
              </td>

              <td class="px-3 py-2 text-xs">
                <% if (c.finalStatus) { %>
                  <span class="px-2 py-0.5 rounded-full text-xs font-semibold
                    <%= c.finalStatus==='Offered'           ? 'bg-green-100 text-green-800' :
                       c.finalStatus==='Offer in Progress' ? 'bg-green-50 text-green-700' :
                       c.finalStatus==='Yet to Join'       ? 'bg-yellow-50 text-yellow-700' :
                       'bg-gray-100 text-gray-800' %>"><%= c.finalStatus %></span>
                <% } else { %>—<% } %>
              </td>

              <td class="px-3 py-2 text-xs flex gap-2">
                <a href="/candidates/<%= c._id %>" class="text-blue-600 hover:underline">View</a>
                <a href="/candidates/<%= c._id %>/edit" class="text-green-600 hover:underline">Edit</a>
                <form method="POST" action="/candidates/<%= c._id %>/delete" onsubmit="return confirm('Delete this candidate?');">
                  <button type="submit" class="text-red-600 hover:underline">Delete</button>
                </form>
              </td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>

  <!-- CARDS (mobile) -->
  <div class="block md:hidden space-y-4">
    <% if (!candidates || candidates.length === 0) { %>
      <div class="bg-white dark:bg-gray-800 rounded-lg p-4 text-center text-gray-500">No candidates found.</div>
    <% } else { %>
      <% candidates.forEach((c, idx) => { %>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 fade-up" style="animation-delay:<%= idx * 80 %>ms">
          <div x-data='{
                name: <%- JSON.stringify(c.candidateName || "Candidate") %>,
                text:"", i:0, forward:true, t:80, d:30, pause:900,
                init(){ const self=this; (function step(){ if(self.forward){ if(self.i < self.name.length){ self.text += self.name[self.i++]; setTimeout(step,self.t); } else { self.forward=false; setTimeout(step,self.pause); } } else { if(self.i>0){ self.text = self.text.slice(0,-1); self.i--; setTimeout(step,self.d); } else { self.forward=true; setTimeout(step,300); } } })(); }
              }' x-init="init()" class="flex flex-col gap-2">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100">
                <span x-text="text"></span><span class="typing-caret" aria-hidden="true"></span>
              </h3>
              <span class="text-xs text-gray-500"><%= c.dateOfCall ? (new Date(c.dateOfCall)).toISOString().slice(0,10) : '—' %></span>
            </div>

            <div class="mt-2 text-sm text-gray-600 dark:text-gray-300">
              <div><strong>Position:</strong> <%= c.position || '—' %></div>
              <div class="mt-1"><strong>Mobile:</strong> <%= c.mobile || '—' %></div>
              <div class="mt-1"><strong>HR:</strong>
                <% if (c.hrStatus) { %><span class="px-2 py-0.5 rounded-full text-xs <%= c.hrStatus==='Reject' ? 'bg-red-100 text-red-800' : c.hrStatus==='Hold' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800' %>"><%= c.hrStatus %></span><% } else { %>—<% } %>
              </div>
            </div>

            <div class="mt-3 flex items-center justify-between">
              <div class="text-xs text-gray-500">Ref: <%= c.serialRefNumber || '—' %></div>
              <div class="flex gap-2">
                <a href="/candidates/<%= c._id %>" class="px-2 py-1 bg-blue-50 text-blue-700 rounded text-xs">View</a>
                <a href="/candidates/<%= c._id %>/edit" class="px-2 py-1 bg-green-50 text-green-700 rounded text-xs">Edit</a>
              </div>
            </div>
          </div>
        </div>
      <% }) %>
    <% } %>
  </div>

  <!-- Pagination -->
  <% if (pagination && pagination.totalPages > 1) { %>
    <div class="flex flex-wrap justify-center mt-6 gap-2 text-xs sm:text-sm">
      <% for (let i = 1; i <= pagination.totalPages; i++) { %>
        <a href="?page=<%= i %><%= filter.q ? '&q='+encodeURIComponent(filter.q) : '' %>"
           class="px-2 py-1 rounded-lg border <%= i===pagination.page ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100' %>"><%= i %></a>
      <% } %>
    </div>
  <% } %>

</main>

<%- include('../partials/footer') %>
